name: Deploy Bug Report API

on:
  push:
    branches:
      - main
    paths:
      - 'bug-report/**'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Bug Report API to Dokku
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: scenextras

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DOKKU_TEST_SSH_KEY }}

      - name: Add Dokku host to known_hosts
        run: ssh-keyscan -H dokku-scenextras.eastus.cloudapp.azure.com >> ~/.ssh/known_hosts

      - name: Deploy to Dokku via subtree
        run: |
          DOKKU_HOST="dokku-scenextras.eastus.cloudapp.azure.com"
          DOKKU_APP="bug-report"

          echo "üöÄ Deploying bug-report to Dokku..."
          echo "üìù Commit: ${{ github.sha }}"

          # Add Dokku remote
          git remote add dokku dokku@${DOKKU_HOST}:${DOKKU_APP} 2>/dev/null || true

          # Push subtree to Dokku
          git subtree push --prefix=bug-report dokku main

          echo "‚úÖ Deployment initiated!"

      - name: Verify deployment
        run: |
          echo "üîç Verifying deployment..."
          sleep 10

          MAX_RETRIES=30
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HEALTH=$(curl -s http://bug-report.dokku-scenextras.eastus.cloudapp.azure.com/health 2>/dev/null || echo "")
            if echo "$HEALTH" | grep -q "healthy"; then
              echo "‚úÖ Health check passed!"
              echo "$HEALTH"
              exit 0
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "‚è≥ Waiting for health check... (${RETRY_COUNT}/${MAX_RETRIES})"
            sleep 2
          done

          echo "‚ö†Ô∏è Health check not reachable (DNS may need time), but deployment completed"
