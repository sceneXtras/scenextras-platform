# GitHub Copilot Agent Workflow
#
# Triggers Copilot agent execution directly from GitHub Actions.
# Can be triggered by:
# - workflow_dispatch (manual with prompt input)
# - Issue labeled "@copilot"
# - PR comment containing "@copilot"
# - Repository dispatch (for external triggers)

name: Copilot Agent

on:
  # Manual trigger with prompt input
  workflow_dispatch:
    inputs:
      prompt:
        description: "Task for Copilot agent"
        required: true
        type: string
      model:
        description: "AI model to use"
        required: false
        default: "claude-opus-4.5"
        type: choice
        options:
          - claude-opus-4.5
          - claude-sonnet-4
          - claude-opus-4
          - gpt-4o
          - gpt-5
      create_pr:
        description: "Create a PR with changes"
        required: false
        default: true
        type: boolean

  # Issue labeled with "@copilot"
  issues:
    types: [labeled]

  # PR or issue comment
  issue_comment:
    types: [created]

  # External trigger (from n8n, Huginn, etc.)
  repository_dispatch:
    types: [copilot-agent]

# Concurrency: only one agent at a time per repo
concurrency:
  group: copilot-agent
  cancel-in-progress: false

jobs:
  run-agent:
    runs-on: ubuntu-latest

    # Only run if:
    # - workflow_dispatch OR
    # - Issue labeled "@copilot" OR
    # - Comment contains "@copilot" OR
    # - repository_dispatch
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'repository_dispatch' ||
      (github.event_name == 'issues' && github.event.label.name == '@copilot') ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@copilot'))

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 100
          token: ${{ secrets.COPILOT_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Copilot CLI
        run: npm i -g @github/copilot

      - name: Determine prompt
        id: prompt
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "prompt<<EOF" >> $GITHUB_OUTPUT
            echo "${{ github.event.inputs.prompt }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "model=${{ github.event.inputs.model || 'claude-opus-4.5' }}" >> $GITHUB_OUTPUT
            echo "create_pr=${{ github.event.inputs.create_pr || 'true' }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "prompt<<EOF" >> $GITHUB_OUTPUT
            echo "${{ github.event.client_payload.prompt }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "model=${{ github.event.client_payload.model || 'claude-opus-4.5' }}" >> $GITHUB_OUTPUT
            echo "create_pr=${{ github.event.client_payload.create_pr || 'true' }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "issues" ]; then
            # Use issue body as prompt
            echo "prompt<<EOF" >> $GITHUB_OUTPUT
            echo "${{ github.event.issue.body }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "model=claude-opus-4.5" >> $GITHUB_OUTPUT
            echo "create_pr=true" >> $GITHUB_OUTPUT
          else
            # Extract prompt from comment (remove @copilot mention)
            COMMENT="${{ github.event.comment.body }}"
            PROMPT=$(echo "$COMMENT" | sed 's/@copilot//g' | xargs)
            echo "prompt<<EOF" >> $GITHUB_OUTPUT
            echo "$PROMPT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "model=claude-opus-4.5" >> $GITHUB_OUTPUT
            echo "create_pr=${{ !github.event.issue.pull_request }}" >> $GITHUB_OUTPUT
          fi

      - name: Build Copilot prompt
        id: build_prompt
        env:
          RAW_PROMPT: ${{ steps.prompt.outputs.prompt }}
        run: |
          # Detect bug report: check for YAML frontmatter with report_id or [Bug] in title
          IS_BUG_REPORT=false
          if echo "$RAW_PROMPT" | grep -q 'report_id:'; then
            IS_BUG_REPORT=true
          fi
          if echo "$RAW_PROMPT" | grep -q '\[Bug\]'; then
            IS_BUG_REPORT=true
          fi

          if [ "$IS_BUG_REPORT" = "true" ]; then
            echo "Detected bug report - wrapping in investigation prompt"

            cat > /tmp/copilot-prompt.txt << 'PROMPT_EOF'
          You are a senior software engineer investigating and fixing a bug in the SceneXtras platform.

          ## Your Task
          1. ANALYZE the bug report below - understand the user's issue, platform, route, and logs
          2. INVESTIGATE the codebase - find the relevant files using the route and code hints
          3. IDENTIFY the root cause by tracing the error through logs and code
          4. IMPLEMENT a fix - make minimal, targeted changes
          5. VERIFY your fix addresses the issue described

          ## Codebase Context
          - Python API Backend: `sceneXtras/api/` (FastAPI)
          - React Web Frontend: `frontend_webapp/` (React 18 + TypeScript)
          - Go Search Engine: `golang_search_engine/`
          - React Native Mobile App: `mobile_app_sx/` (Expo)
          - See CLAUDE.md for full architecture details

          ## Investigation Protocol
          1. Read the bug report metadata (platform, route, severity)
          2. Check the investigation hints for relevant file paths
          3. Read the application logs for error patterns
          4. Open and read the relevant source files
          5. Trace the bug from the user action → code path → failure point
          6. Write the fix with proper error handling
          7. Do NOT add features or refactor - only fix the reported issue

          ## Rules
          - Make MINIMAL changes - fix the bug, nothing else
          - Follow existing code patterns in each service
          - Add error handling only where the bug occurs
          - Do NOT modify test files unless the fix requires it
          - Wrap significant changes behind a feature flag if appropriate

          ## Bug Report
          ---
          PROMPT_EOF

            # Append the raw issue body
            echo "$RAW_PROMPT" >> /tmp/copilot-prompt.txt
            echo '---' >> /tmp/copilot-prompt.txt

            echo "final_prompt_file=/tmp/copilot-prompt.txt" >> $GITHUB_OUTPUT
            echo "is_bug_report=true" >> $GITHUB_OUTPUT
          else
            echo "Not a bug report - passing prompt through unchanged"
            echo "$RAW_PROMPT" > /tmp/copilot-prompt.txt
            echo "final_prompt_file=/tmp/copilot-prompt.txt" >> $GITHUB_OUTPUT
            echo "is_bug_report=false" >> $GITHUB_OUTPUT
          fi

          echo "Prompt size: $(wc -c < /tmp/copilot-prompt.txt) bytes"

      - name: Create agent branch
        id: branch
        run: |
          BRANCH_NAME="copilot-agent/$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Configure git
        run: |
          git config user.email "copilot-agent@scenextras.com"
          git config user.name "Copilot Agent"

      - name: Setup MCP config
        env:
          MCP_SCENEXTRAS_API_KEY: ${{ secrets.MCP_SCENEXTRAS_API_KEY }}
        run: |
          # Copilot CLI reads MCP config from ~/.copilot/mcp-config.json
          mkdir -p ~/.copilot
          cat > ~/.copilot/mcp-config.json << EOF
          {
            "mcpServers": {
              "scenextras-debug": {
                "type": "http",
                "url": "https://mcp.scenextras.com/mcp",
                "headers": {
                  "X-API-Key": "${MCP_SCENEXTRAS_API_KEY}"
                }
              }
            }
          }
          EOF
          echo "MCP config written to ~/.copilot/mcp-config.json"

      - name: Run Copilot Agent
        id: copilot
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          set +e  # Don't exit on error

          echo "Running Copilot agent with model: ${{ steps.prompt.outputs.model }}"
          echo "Bug report mode: ${{ steps.build_prompt.outputs.is_bug_report }}"
          echo "Prompt file size: $(wc -c < ${{ steps.build_prompt.outputs.final_prompt_file }}) bytes"
          echo "---"

          # Run Copilot CLI (-p for non-interactive prompt)
          copilot -p "$(cat ${{ steps.build_prompt.outputs.final_prompt_file }})" \
            --model "${{ steps.prompt.outputs.model }}" \
            --allow-all-tools \
            --allow-all-paths \
            < /dev/null 2>&1 | tee copilot-output.txt

          EXIT_CODE=$?

          # Check for changes
          CHANGED_FILES=$(git status --porcelain | wc -l | xargs)
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          if [ "$CHANGED_FILES" -gt 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "Copilot made $CHANGED_FILES file changes"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "No changes made by Copilot"
          fi

      - name: Commit changes
        if: steps.copilot.outputs.changed_files > 0
        run: |
          git add -A
          git reset HEAD copilot-output.txt .github/copilot-mcp.json 2>/dev/null || true
          git reset HEAD ~/.copilot/ /tmp/copilot-prompt.txt 2>/dev/null || true
          git commit -m "[copilot-agent] ${{ steps.prompt.outputs.prompt }}" \
            -m "" \
            -m "Triggered by: ${{ github.event_name }}" \
            -m "Model: ${{ steps.prompt.outputs.model }}" \
            -m "Actor: ${{ github.actor }}"

      - name: Push and create PR
        if: steps.copilot.outputs.changed_files > 0 && steps.prompt.outputs.create_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git push origin ${{ steps.branch.outputs.branch }}

          # Create PR
          gh pr create \
            --title "[Copilot Agent] ${{ steps.prompt.outputs.prompt }}" \
            --body "## Summary

          This PR was automatically generated by a Copilot agent.

          ### Task
          ${{ steps.prompt.outputs.prompt }}

          ### Trigger
          - Event: \`${{ github.event_name }}\`
          - Actor: @${{ github.actor }}
          - Model: \`${{ steps.prompt.outputs.model }}\`

          ### Copilot Output
          \`\`\`
          $(cat copilot-output.txt | tail -100)
          \`\`\`

          ---
          Generated with [Copilot Agent Trigger](https://github.com/scenextras/copilot-agent-trigger)" \
            --base ${{ github.event.repository.default_branch }}

      - name: Comment on issue (if triggered by issue)
        if: github.event_name == 'issues' || github.event_name == 'issue_comment'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}

          if [ "${{ steps.copilot.outputs.success }}" = "true" ]; then
            gh issue comment $ISSUE_NUMBER \
              --body "Copilot agent completed. Made ${{ steps.copilot.outputs.changed_files }} file changes. PR created."
          else
            gh issue comment $ISSUE_NUMBER \
              --body "Copilot agent ran but made no changes. Exit code: ${{ steps.copilot.outputs.exit_code }}"
          fi

      - name: Upload Copilot output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: copilot-output
          path: copilot-output.txt
          retention-days: 7
