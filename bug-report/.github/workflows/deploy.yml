name: Deploy to Dokku

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Bug Report API to Dokku
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: scenextras

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DOKKU_TEST_SSH_KEY }}

      - name: Add Dokku host to known_hosts
        run: ssh-keyscan -H dokku-scenextras.eastus.cloudapp.azure.com >> ~/.ssh/known_hosts

      - name: Deploy to Dokku
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Set variables
          DOKKU_HOST="dokku-scenextras.eastus.cloudapp.azure.com"
          DOKKU_APP="bug-report"
          BRANCH="main"

          echo "üöÄ Starting deployment of bug-report to Dokku..."
          echo "üìù Commit: ${{ github.sha }}"
          echo "üë§ Actor: ${{ github.actor }}"

          # Add Dokku remote
          git remote add dokku dokku@${DOKKU_HOST}:${DOKKU_APP} 2>/dev/null || true

          # Push to Dokku
          echo "üì§ Pushing to Dokku..."
          git push dokku ${BRANCH}:master --force

          # Check deployment status
          echo "üîç Checking deployment status..."
          sleep 5

          # Verify health endpoint
          MAX_RETRIES=30
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s https://${DOKKU_APP}.dokku-scenextras.eastus.cloudapp.azure.com/health > /dev/null 2>&1; then
              echo "‚úÖ Health check passed!"
              break
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "‚è≥ Waiting for health check... (${RETRY_COUNT}/${MAX_RETRIES})"
            sleep 2
          done

          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "‚ùå Health check failed after ${MAX_RETRIES} retries"
            exit 1
          fi

          echo "‚úÖ Deployment successful!"

          # Send Discord notification on success
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "‚úÖ Bug Report API Deployed",
                  "description": "Deployment successful\n\nCommit: ${{ github.sha }}\nBranch: ${{ github.ref_name }}\nActor: ${{ github.actor }}\nURL: https://bug-report.dokku-scenextras.eastus.cloudapp.azure.com",
                  "color": 5763719,
                  "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
                }]
              }'
          fi

      - name: Notify on failure
        if: failure()
        run: |
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "‚ùå Bug Report API Deployment Failed",
                  "description": "Deployment failed in GitHub Actions\n\nCommit: ${{ github.sha }}\nBranch: ${{ github.ref_name }}\nActor: ${{ github.actor }}",
                  "color": 15158332,
                  "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
                }]
              }'
          fi
